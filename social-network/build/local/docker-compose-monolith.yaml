networks:
  social-network-shared-net:
    external: true

volumes:
  monolith-db-master-vol:
  monolith-db-slave1-vol:
  monolith-db-slave2-vol:
  monolith-valkey-vol:
  monolith-rabbitmq-vol:

services:
  monolith_db_master:
    image: postgres:17-alpine
    hostname: monolith_db_master
    environment:
      POSTGRES_USER: ${MONOLITH_DB_USER}
      POSTGRES_PASSWORD: ${MONOLITH_DB_PASSWORD}
      POSTGRES_DB: ${MONOLITH_DB_NAME}
      DOCKER_SUBNET: ${DOCKER_SUBNET}
    expose:
      - "5432"
    volumes:
      - monolith-db-master-vol:/var/lib/postgresql/data
      - ./pg_master:/docker-entrypoint-initdb.d
    networks:
      - social-network-shared-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${MONOLITH_DB_USER}" ]
      interval: 5s
      timeout: 30s
      retries: 5

  monolith_db_slave1: &monolith_db_slave
    build:
      context: ./pg_slave
    hostname: monolith_db_slave1
    environment:
      POSTGRES_USER: ${MONOLITH_DB_USER}
      POSTGRES_PASSWORD: ${MONOLITH_DB_PASSWORD}
      POSTGRES_DB: ${MONOLITH_DB_NAME}
    depends_on:
      monolith_db_master:
        condition: service_healthy
    volumes:
      - monolith-db-slave1-vol:/var/lib/postgresql/data
    networks:
      - social-network-shared-net
    expose:
      - "5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${MONOLITH_DB_USER}" ]
      interval: 5s
      timeout: 30s
      retries: 5

  monolith_db_slave2:
    <<: *monolith_db_slave
    hostname: monolith_db_slave2
    volumes:
      - monolith-db-slave2-vol:/var/lib/postgresql/data

  monolith_valkey:
    image: valkey/valkey:7.2-alpine
    environment:
      - VALKEY_PASSWORD=${MONOLITH_VALKEY_PASSWORD}
    volumes:
      - monolith-valkey-vol:/data
    command: >
      valkey-server
      --requirepass ${MONOLITH_VALKEY_PASSWORD}
      --save 60 1
      --loglevel notice
      --protected-mode no
    healthcheck:
      test: [ "CMD", "valkey-cli", "-a", "${MONOLITH_VALKEY_PASSWORD}", "ping" ]
      interval: 5s
      timeout: 30s
      retries: 5
    networks:
      - social-network-shared-net

  monolith_rabbitmq:
    image: rabbitmq:3.12-management-alpine
    ports:
      - "${MONOLITH_RABBITMQ_PORT}:5672"
      - "${MONOLITH_RABBITMQ_ADMIN_PORT}:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - monolith-rabbitmq-vol:/var/lib/rabbitmq
    networks:
      - social-network-shared-net
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 5s
      timeout: 100s
      retries: 20

  monolith_migrate:
    build:
      context: ../../monolith
      dockerfile: ../build/Dockerfile-monolith
    depends_on:
      monolith_db_master:
        condition: service_healthy
      monolith_db_slave1:
        condition: service_healthy
      monolith_db_slave2:
        condition: service_healthy
      monolith_rabbitmq:
        condition: service_healthy
      monolith_valkey:
        condition: service_healthy
    env_file:
      - .env.monolith
    command: ["migrate", "up"]
    restart: on-failure
    networks:
      - social-network-shared-net

  monolith_app_1: &monolith_app
    build:
      context: ../../monolith
      dockerfile: ../build/Dockerfile-monolith
    hostname: monolith_app_1
    depends_on:
      - monolith_migrate
    env_file:
      - .env.monolith
    expose:
      - "8080"
    restart: unless-stopped
    networks:
      - social-network-shared-net

  monolith_app_2:
    <<: *monolith_app
    hostname: monolith_app_2

  monolith_app_3:
    <<: *monolith_app
    hostname: monolith_app_3

  monolith_task_processor:
    build:
      context: ../../monolith
      dockerfile: ../build/Dockerfile-monolith
    depends_on:
      - monolith_app_1
      - monolith_app_2
      - monolith_app_3
    env_file:
      - .env.monolith
    command: [ "task_process" ]
    restart: unless-stopped
    networks:
      - social-network-shared-net

  monolith_websocket:
    build:
      context: ../../monolith
      dockerfile: ../build/Dockerfile-monolith
    depends_on:
      - monolith_app_1
      - monolith_app_2
      - monolith_app_3
    env_file:
      - .env.monolith
    expose:
      - "8080"
    command: [ "ws_serve" ]
    restart: unless-stopped
    networks:
      - social-network-shared-net